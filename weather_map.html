<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather-Map-Project</title>

    <!-- mapBox CSS -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>


   <!--Geocoder Link-->
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.4/mapbox-gl-geocoder.css' type='text/css' />


    <!-- Custom CSS -->
    <style>


        html, body {
            background-color: cornflowerblue;

        }

        img {

            width: 60px;
            height: 40px;

        }


        #map {
            /* the width and height may be set to any size */
            width: 100%;
            height: 400px;


        }


        .wrapper {
            border-style: solid;
        }


        .pageWrapper {
            padding-right: 10%;
            padding-left: 10%;
            align-content: center;

        }

        .column {


            float: left;
            width: 33.33%;
            text-align: center;
            align-content: center;
            color: white;


        }

        .three-day-forecast {

            content: "";
            display: table;
            clear: both;
            width: 100%;
            height: 150px;
            background-color: grey;
            margin-bottom: 2.5%;


        }


    </style>
</head>
<body>

<h1>Weather Application</h1>




<h2 class="city"></h2>

<div class="pageWrapper">

    <div class="three-day-forecast"></div>


    <!-- The HTML element that serves as the Mapbox container -->
    <div id='map'></div>

</div>

<!--Private Access Code to Dark Sky and mapBox-->

<script src="js/keys.js"></script>

<!--jquery library-->

<script src="js/jquery-3.3.1.js"></script>

<!-- Mapbox JS -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>

<!--Access to ajax library-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<!--Geocoder--------------->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.4/mapbox-gl-geocoder.min.js'></script>

<!-- Mapbox Geocoder Util Methods -->
<script src="js/mapbox-geocoder-utils.js"></script>




<!--Custom javascript-->

<script>

    (function () {
            "use strict";


            //  var latitude = $('#lat').val();
            //  var longitude = $('#long').val();
            //
            // console.log($('#lat').val());
            //  console.log($('#long').val());


            mapboxgl.accessToken = mapboxglaccessToken;


            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v9',
                center: [-98.5795, 39.828175],
                zoom: 3


            });


            reverseGeocode({lng:-98.491142, lat: 29.424349}, mapboxglaccessToken).then(function (results) {

                $('h2').append(results);

                console.log( results);


            });


            var geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken
            });

            map.addControl(geocoder);

            map.on('load', function() {
                map.addSource('single-point', {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": []
                    }
            });



// Listen for the `result` event from the MapboxGeocoder that is triggered when a user
// Passes the coordination for result to darkSky



            geocoder.on('result', function (ev) {

                $('.three-day-forecast').html('');

                map.getSource('single-point').setData(ev.result.geometry)


                var coordination = ('/' + ev.result.bbox[1] + ',' + ev.result.bbox[0]);
                console.log(ev.result.bbox[0]);

                var weather = $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + coordination);

                marker.setLngLat([ev.result.bbox[0], ev.result.bbox[1]]);
                marker.addTo(map);




                weather.done(function(weather) {


                    threeDayForecast(weather);

                });
            });

        });






        $('.three-day-forecast').html('');


        // var lngLat = marker.getLngLat()

            var marker = new mapboxgl.Marker({
                draggable: true
            });

            marker.setLngLat([-98.491142, 29.424349]);
            $("#lat").append().attr("value", -98.491142);
            $("#long").append().attr("value", 29.424349);
            marker.addTo(map);






            function threeDayForecast(weather){




                //Three day forecast to have. I need a daily forecast of icon, summary, humidity, windspeed round, pressure, average temperature high and low.

                // icon optional
                // A machine-readable text summary of this data point, suitable for selecting an icon for display.
                // If defined, this property will have one of the following values: clear-day, clear-night, rain, snow, sleet, wind, fog, cloudy, partly-cloudy-day,
                // or partly-cloudy-night. (Developers should ensure that a sensible default is defined, as additional values, such as hail, thunderstorm, or tornado,
                // may be defined in the future.)


                //Create an array of JS objects containing a property for each of the following conditions: clear-day, clear-night, rain, snow, sleet, wind, fog, cloudy, partly-cloudy-day, partly-cloudy-night.





                var conditionsArrayObjects = [

                    {
                        icon: "partly-cloudy-day",

                        img: $('<img />', {
                            id: 'iconIDPartlyCloudy',
                            src: "icon/partlyCloudy.png",
                            alt: "iconAlt"
                        })


                    },

                    {
                        icon: 'rain',

                        img: $('<img />', {
                            id: 'iconIDRain',
                            src: "icon/rain.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'sunny',

                        img: $('<img />', {
                            id: 'iconIDSunny',
                            src: "icon/Sunny.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'snow',

                        img: $('<img />', {
                            id: 'iconIDSnow',
                            src: "icon/snowflake.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'cloudy',

                        img: $('<img />', {
                            id: 'iconIDCloudy',
                            src: "icon/cloudy.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'wind',

                        img: $('<img />', {
                            id: 'iconIDWind',
                            src: "icon/wind.png",
                            alt: "iconAlt"
                        })
                    }


                ];

                //Add a property to the array of icon objects for the url to the location that the appropriate icon is stored locally.


                for (var i = 0; i < 3; i++) {



                    $('.three-day-forecast').append('<div class="column">' + '<div class="wrapper">' +
                        '<h2>' + weather.daily.data[i].temperatureLow + "&#176/" + weather.daily.data[i].temperatureHigh + "&#176" + '</h2>' +
                        '<h2 class="appendIcon">' +
                        '<h4>' + weather.daily.data[i].icon + '</h4>' + '</h2>' +
                        '<h4>' + 'Humidity: ' + weather.daily.data[i].humidity + '</h4>' +
                        '<h4>' + 'wind: ' + weather.daily.data[i].windSpeed + '</h4>' +
                        '<h4>' + 'Pressure: ' + weather.daily.data[i].pressure + '</h4>' +
                        '</div>' + '</div>');




                    //for each


                    conditionsArrayObjects.forEach(function (element){

                        if(weather.daily.data[i].icon === element.icon){

                            element.img.appendTo($('.appendIcon'));
                        }


                    });


                }
            }

            marker.on('dragend', onDragEnd);

            // 29.424349,-98.491142 (San Antonio)
            // 40.646061, -111.497971 (Park City)

        // reverse geocode method from mapbox-geocoder-utils.js





            $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + "/29.424349,-98.491142").done(function (weather) {
                //loop


                var timeConversion = new Date((weather.daily.data[0].time * 1000));
                console.log(timeConversion.toString());

                threeDayForecast(weather);

            });


            function onDragEnd() {

                $('.three-day-forecast').html('');


                var lngLat = marker.getLngLat();
                $("#lat").append().attr("value", marker._lngLat.lat);
                $("#long").append().attr("value", marker._lngLat.lng);
                var coordination = ('/' + marker._lngLat.lat + ',' + marker._lngLat.lng);
                console.log(marker._lngLat.lat);

                $('h2').html('');

                reverseGeocode({lng:marker._lngLat.lng, lat: marker._lngLat.lat}, mapboxglaccessToken).then(function (results) {

                    $('h2').append(results);



                });




               var weather = $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + coordination);

                   weather.done(function(weather) {


                    threeDayForecast(weather);

                });

            }

            //Function to update weather forecast based off of search results










        }

    )();

</script>

</body>
</html>