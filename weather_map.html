<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather-Map-Project</title>

    <!-- mapBox CSS -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>


    <!--Geocoder Link-->
    <link rel='stylesheet'
          href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.4/mapbox-gl-geocoder.css'
          type='text/css'/>


    <!-- Custom CSS -->
    <style>


        html, body {
            background-color: cornflowerblue;

        }

        /*Icon img Size*/
        img {

            width: 60px;
            height: 40px;

        }

        /*Map Dimensions*/
        #map {
            width: 100%;
            height: 400px;


        }

        /*3-day forecast border wrapper*/
        .wrapper {
            border-style: solid;
        }

        /*wraps three day forecast and img*/
        .pageWrapper {
            padding-right: 10%;
            padding-left: 10%;
            align-content: center;

        }

        /*appending forecast info to columns*/
        .column {


            float: left;
            width: 33.33%;
            text-align: center;
            align-content: center;
            color: white;


        }

        /*forecast table*/
        .three-day-forecast {

            content: "";
            display: table;
            clear: both;
            width: 100%;
            height: 150px;
            background-color: grey;
            margin-bottom: 2.5%;


        }

        #streets {
            background-image: url(https://media.giphy.com/media/l4FGF98EYYUovuL9m/giphy.gif);
            height: 14%;
            width: 15%;
            z-index: 2;
            position: absolute;
            top: 500px;


        }

        #satellite {
            background-image: url(https://media.giphy.com/media/8Am0UlfiwZcgEDOy4h/giphy.gif);
            height: 14%;
            width: 15%;
            z-index: 2;
            position: absolute;
            top: 500px;
        }


    </style>
</head>
<body>

<h1>Weather Application</h1>


<!--Appending long lat city information-->

<h2 class="city"></h2>

<div class="pageWrapper">

    <div class="three-day-forecast"></div>

    <!-- The HTML element that serves as the Mapbox container -->

    <div id='map'></div>

    <!--Alternating between street and satellite view-->

    <div>
        <button id="satellite" class="layers"></button>
    </div>

</div>

<!--Private Access Code to Dark Sky and mapBox-->

<script src="js/keys.js"></script>

<!--jquery library-->

<script src="js/jquery-3.3.1.js"></script>

<!-- Mapbox JS -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>

<!--Access to ajax library-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<!--Geocoder--------------->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.4/mapbox-gl-geocoder.min.js'></script>

<!-- Mapbox Geocoder Util Methods -->
<script src="js/mapbox-geocoder-utils.js"></script>


<!--Custom javascript-->

<script>

    (function () {
            "use strict";



            function markerAndSearchFunctionalities() {


                //To-do: Fix address issue, Enter city issue

                mapboxgl.accessToken = mapboxglaccessToken;

                //Map centered over San Antonio
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    center: [-98.5795, 39.828175],
                    zoom: 3


                });



                // satellite and streets view button. Include functionalities:
                $(".layers").click(function (layer) {
                    var layerId = layer.target.id;

                    if (layerId === 'streets') {
                        $(".layers").attr("id", "satellite");
                        map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
                    }

                    if (layerId === 'satellite') {
                        $(".layers").attr("id", "streets");
                        map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
                    }
                });


                //San Antonio reverseGeoCode appending results to h2 Default after loading page

                reverseGeocode({lng: -98.491142, lat: 29.424349}, mapboxglaccessToken).then(function (results) {

                    $('h2').append(results);

                    console.log(results);


                });


                //Geocoder searching functionality implemented to map

                var geocoder = new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken
                });

                map.addControl(geocoder);

                //Geocoder results to implementation-new coordinates

                map.on('load', function () {
                    map.addSource('single-point', {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": []
                        }
                    });

                    // Add zoom and rotation controls to the map.

                    var navZoom = new mapboxgl.NavigationControl();
                    map.addControl(navZoom);


                    // navZoom.on('click', function (e) {
                    //
                    //     map.flyTo({center: e.features[0].geometry.coordinates});
                    //
                    // });




                    // Listen for the `result` event from the MapboxGeocoder that is triggered when a user
                    // Passes the coordination for result to darkSky

                    geocoder.on('result', function (ev) {

                        //Clearing table

                        $('.three-day-forecast').html('');

                        //Get the lat and longs from the map Source geocoder search

                        map.getSource('single-point').setData(ev.result.geometry)


                        var coordination = ('/' + ev.result.bbox[1] + ',' + ev.result.bbox[0]);
                        console.log(ev.result.bbox[0]);

                        //Feed the coordinates from the search box to the darkSky update forecast

                        var weather = $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + coordination);

                        //Move markers to new location

                        marker.setLngLat([ev.result.bbox[0], ev.result.bbox[1]]);
                        marker.addTo(map);






                        weather.done(function (weather) {


                            threeDayForecast(weather);

                        });
                    });

                });


                //Clears appended table

                $('.three-day-forecast').html('');


                // marker location set on San Antonio

                var marker = new mapboxgl.Marker({
                    draggable: true
                });

                marker.setLngLat([-98.491142, 29.424349]);
                marker.addTo(map);

                //Marker drag causes onDragEnd function to execute

                marker.on('dragend', onDragEnd);

                function onDragEnd() {

                    //Clear table

                    $('.three-day-forecast').html('');

                    //get lang and lat based off new marker location

                    var lngLat = marker.getLngLat();

                    var coordination = ('/' + marker._lngLat.lat + ',' + marker._lngLat.lng);
                    console.log(marker._lngLat.lat);

                    //clear address

                    $('h2').html('');


                    //Appending the name of the reverseGeoCode coordinates to h2
                    reverseGeocode({
                        lng: marker._lngLat.lng,
                        lat: marker._lngLat.lat
                    }, mapboxglaccessToken).then(function (results) {

                        $('h2').append(results);


                    });

                    //Update the weather based off of new coordinates from marker

                    var weather = $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + coordination);

                    weather.done(function (weather) {


                        threeDayForecast(weather);

                    });

                }


            }


            function threeDayForecast(weather) {



                //Array of Weather Icons
                var conditionsArrayObjects = [

                    {
                        icon: "partly-cloudy-day",

                        img: $('<img />', {
                            id: 'iconIDPartlyCloudy',
                            src: "icon/partlyCloudy.png",
                            alt: "iconAlt"
                        })


                    },

                    {
                        icon: 'rain',

                        img: $('<img />', {
                            id: 'iconIDRain',
                            src: "icon/rain.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'sunny',

                        img: $('<img />', {
                            id: 'iconIDSunny',
                            src: "icon/Sunny.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'snow',

                        img: $('<img />', {
                            id: 'iconIDSnow',
                            src: "icon/snowflake.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'cloudy',

                        img: $('<img />', {
                            id: 'iconIDCloudy',
                            src: "icon/cloudy.png",
                            alt: "iconAlt"
                        })
                    },

                    {
                        icon: 'wind',

                        img: $('<img />', {
                            id: 'iconIDWind',
                            src: "icon/wind.png",
                            alt: "iconAlt"
                        })
                    }


                ];

                //Appending weather information from darkSky to the forecast table

                for (var i = 0; i < 3; i++) {


                    $('.three-day-forecast').append('<div class="column">' + '<div class="wrapper">' +
                        '<h2>' + weather.daily.data[i].temperatureLow + "&#176/" + weather.daily.data[i].temperatureHigh + "&#176" + '</h2>' +
                        '<h2 class="appendIcon">' +
                        '<h4>' + weather.daily.data[i].icon + '</h4>' + '</h2>' +
                        '<h4>' + 'Humidity: ' + weather.daily.data[i].humidity + '</h4>' +
                        '<h4>' + 'wind: ' + weather.daily.data[i].windSpeed + '</h4>' +
                        '<h4>' + 'Pressure: ' + weather.daily.data[i].pressure + '</h4>' +
                        '</div>' + '</div>');


                    //Log for appending weather icons using loop (need to revise)

                    conditionsArrayObjects.forEach(function (element) {

                        if (weather.daily.data[i].icon === element.icon) {
                            $('.appendIcon').prepend(element.img)
                        }


                    });


                }
            }




            markerAndSearchFunctionalities();


            //Feeding darkSky San Antonio coordinates for forecast


            $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkySecretCode + "/29.424349,-98.491142").done(function (weather) {
                //loop


                threeDayForecast(weather);

            });





        }

    )();

</script>

</body>
</html>